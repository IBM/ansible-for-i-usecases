- hosts: localhost
  collections:
    - ibm.power_ibmi
  tasks:
    - block:
        - name: remove build path
          file:
            path: '{{ build_path }}'
            state: 'absent'
          delegate_to: '{{ item }}'
          with_items:
            - "{{ host_names.split() }}"
          ignore_errors: true
          when: not provision|bool

        - name: remove build lib
          ibm.power_ibmi.ibmi_cl_command:
            cmd: DLTLIB {{ build_lib }}
          delegate_to: '{{ item }}'
          with_items:
            - "{{ host_names.split() }}"
          ignore_errors: true
          when: not provision|bool

        - name: Destroy VM when provision
          os_server:
            auth:
              auth_url: https://{{ ansible_ssh_host }}:5000/v3
              username: '{{ ansible_ssh_user }}'
              password: '{{ ansible_ssh_pass }}'
              project_name: '{{ project }}'
              project_domain_name: '{{ project_domain }}'
              user_domain_name: '{{ user_domain }}'
            name: '{{ vm_name }}'
            verify: '{{ verify_cert }}'
            state: 'absent'
          delegate_to: 'powervc'
          when: provision|bool
      when: cleanup|bool
